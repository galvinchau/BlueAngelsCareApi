// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // D√πng PostgreSQL (Supabase)
  url      = env("DATABASE_URL")
}

/**
 * Individual = h·ªì s∆° b·ªánh nh√¢n/kh√°ch h√†ng
 * code      = m√£ hi·ªÉn th·ªã: IND-2025-000001
 */
model Individual {
  id   String @id @default(cuid()) // kho√° k·ªπ thu·∫≠t
  code String @unique // m√£ hi·ªÉn th·ªã, s·∫Ω sinh t·ª´ Counter

  firstName  String
  middleName String?
  lastName   String
  dob        String // YYYY-MM-DD
  gender     String?
  ssnLast4   String? // ch·ªâ 4 s·ªë

  branch   String
  location String

  primaryPhone   String?
  secondaryPhone String?
  email          String?

  address1 String?
  address2 String?
  city     String?
  county   String?
  state    String?
  zip      String?

  // acceptedServices: form g·ª≠i l√™n l√† m·∫£ng string, DB l∆∞u d·∫°ng CSV cho ƒë∆°n gi·∫£n
  acceptedServices String

  // Emergency contacts
  emergency1Name           String?
  emergency1Relationship   String?
  emergency1PhonePrimary   String?
  emergency1PhoneSecondary String?
  emergency1Notes          String?

  emergency2Name           String?
  emergency2Relationship   String?
  emergency2PhonePrimary   String?
  emergency2PhoneSecondary String?
  emergency2Notes          String?

  // Billing / guardian
  billingSameAsPrimary Boolean @default(true)
  billingAddress1      String?
  billingAddress2      String?
  billingCity          String?
  billingState         String?
  billingZip           String?

  guardianName  String?
  guardianPhone String?
  repPayeeName  String?
  repPayeePhone String?

  // Clinical
  pcpName    String?
  pcpPhone   String?
  pcpFax     String?
  pcpNpi     String?
  pcpAddress String?
  allergies  String?

  // Preparedness / equipment
  priorityCode       String?
  mobility           String?
  equipOxygen        Boolean @default(false)
  equip_cpap         Boolean @default(false)
  equip_ventilator   Boolean @default(false)
  equip_iv_pump      Boolean @default(false)
  equip_syringe_pump Boolean @default(false)
  equip_feeding_tube Boolean @default(false)
  equip_nebulizer    Boolean @default(false)
  equip_wheelchair   Boolean @default(false)
  equip_hospital_bed Boolean @default(false)
  equipOther         String?

  // Preferences
  prefTime        String?
  prefNotes       String?
  langPrimary     String?
  langSecondary   String?
  caregiverGender String?
  prefOther       String?

  // Advanced directives
  advType      String?
  advDateIn    String?
  advDateOut   String?
  advStatus    String?
  advPhysician String?
  advAttach    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payers      Payer[]
  medications Medication[]
  diagnoses   Diagnosis[]

  // Relations m·ªõi cho Schedule / Visit / ISP
  masterScheduleTemplates MasterScheduleTemplate[]
  scheduleWeeks           ScheduleWeek[]
  scheduleShifts          ScheduleShift[]
  visits                  Visit[]
  ispAllocations          ISPAllocation[]

  // ISP & BSP form (l∆∞u to√†n b·ªô d·ªØ li·ªáu form d·∫°ng JSON)
  ispBspForm IspBspForm?
}

/**
 * Employee = h·ªì s∆° nh√¢n vi√™n Blue Angels Care
 * employeeId = m√£ hi·ªÉn th·ªã: BAC-E-2025-001 (nh·∫≠p t·ª´ form, sau n√†y c√≥ th·ªÉ sinh t·ª± ƒë·ªông b·∫±ng Counter)
 */
model Employee {
  id String @id @default(cuid()) // kho√° k·ªπ thu·∫≠t

  // Demographics
  firstName  String
  middleName String?
  lastName   String
  dob        String? // YYYY-MM-DD
  gender     String?
  phone      String?
  email      String

  educationLevel String? // tr√¨nh ƒë·ªô h·ªçc v·∫•n/chuy√™n m√¥n
  ssn            String? // 9 digits

  // Employment Info
  employeeId      String  @unique // BAC-E-2025-001
  role            String? // DSP / Nurse / Supervisor / ...
  status          String? // Active / On Leave / Inactive
  hireDate        String? // YYYY-MM-DD
  terminationDate String? // YYYY-MM-DD
  employmentType  String? // Full-time / Part-time / Per-diem / Contract
  branch          String? // Altoona / Hollidaysburg / ...
  workLocation    String? // m√¥ t·∫£ chi ti·∫øt h∆°n location
  supervisorName  String? // t√™n supervisor tr·ª±c ti·∫øp

  // Address
  address1 String?
  address2 String?
  city     String?
  state    String?
  zip      String?

  // Emergency Contact
  emergencyName              String?
  emergencyRelationship      String?
  emergencyPhone             String?
  emergencyEmail             String?
  emergencyPreferredLanguage String?
  emergencyAddress           String?

  // Work Preferences
  preferredShift  String? // Morning / Afternoon / Evening / Overnight
  canWorkWeekends Boolean @default(false)
  canWorkHolidays Boolean @default(false)
  maxWeeklyHours  Int?
  notes           String?

  // Notification Preferences
  notifyByEmail       Boolean @default(true)
  notifyBySMS         Boolean @default(false)
  notifyByInApp       Boolean @default(true)
  sendScheduleChanges Boolean @default(true)
  sendPayrollUpdates  Boolean @default(true)
  sendPolicyUpdates   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations m·ªõi
  templateDefaultShifts MasterTemplateShift[] @relation("TemplateDefaultDSP")
  plannedShifts         ScheduleShift[]       @relation("PlannedDSP")
  actualShifts          ScheduleShift[]       @relation("ActualDSP")
  visits                Visit[]               @relation("VisitDSP")

  // Supervisors cho Admin Users
  userSupervisors UserSupervisor[]

  isMobileUser Boolean @default(false) // üëà TH√äM D√íNG N√ÄY

  // ‚úÖ NEW: refresh tokens for mobile "remember device"
  mobileRefreshTokens MobileRefreshToken[]
}

/**
 * Payer: c√°c ƒë·ªëi t∆∞·ª£ng thanh to√°n: Primary / Secondary
 */
model Payer {
  id          String  @id @default(cuid())
  type        String // "Primary" | "Secondary"
  name        String
  plan        String?
  memberId    String
  groupId     String?
  startDate   String?
  endDate     String?
  eligibility String? // Verified | Pending | Not Eligible
  notes       String?

  individualId String
  individual   Individual @relation(fields: [individualId], references: [id], onDelete: Cascade)

  ispAllocations ISPAllocation[]
}

/**
 * Medications
 */
model Medication {
  id       String  @id @default(cuid())
  name     String
  dose     String?
  schedule String?

  individualId String
  individual   Individual @relation(fields: [individualId], references: [id], onDelete: Cascade)
}

/**
 * Diagnoses (ICD)
 */
model Diagnosis {
  id          String  @id @default(cuid())
  icd         String
  description String?
  onset       String? // YYYY-MM-DD

  individualId String
  individual   Individual @relation(fields: [individualId], references: [id], onDelete: Cascade)
}

/**
 * Counter d√πng ƒë·ªÉ sinh code: IND-2025-000001, IND-2025-000002, ...
 * (sau n√†y c√≥ th·ªÉ x√†i chung cho Employee, v√≠ d·ª• id = "EMP-2025")
 */
model Counter {
  id    String @id // v√≠ d·ª•: "IND-2025"
  value Int
}

/**
 * Service = danh m·ª•c d·ªãch v·ª• (d√πng cho Accepted Services + scheduling + billing)
 */
model Service {
  id String @id @default(cuid()) // technical id

  // Short code d√πng chung v·ªõi Accepted Services (PCA, NT, PBIS...)
  serviceCode String @unique // e.g. "PCA"

  // T√™n ƒë·∫ßy ƒë·ªß: "Personal Care Assistant"
  serviceName String

  // M√£ billing / code show cho payer (SVC-001, T1019...)
  billingCode String?

  // "None-Residential" | "Residential service"
  category String

  // M√¥ t·∫£ d·ªãch v·ª•
  description String?

  // "Active" | "Inactive"
  status String

  // C√≥ d√πng ƒë·ªÉ claim/billing kh√¥ng
  billable Boolean @default(true)

  // Ghi ch√∫ n·ªôi b·ªô
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations m·ªõi
  masterTemplateShifts MasterTemplateShift[]
  scheduleShifts       ScheduleShift[]
  visits               Visit[]
  ispAllocations       ISPAllocation[]
}

// =====================================================
//  ENUMS CHO SCHEDULE / VISIT
// =====================================================

enum ScheduleStatus {
  NOT_STARTED // ch∆∞a ƒë·∫øn gi·ªù, ch∆∞a c√≥ visit
  IN_PROGRESS // ƒë√£ check in, ch∆∞a check out
  COMPLETED // c√≥ visit ƒë·∫ßy ƒë·ªß, ƒë√£ ƒë·ªëi so√°t
  NOT_COMPLETED // c√≥ check in nh∆∞ng h·∫øt ca m√† ch∆∞a check out
  CANCELLED // ca b·ªã h·ªßy (th∆∞·ªùng do Individual)
  BACKUP_PLAN // ca c√≥ backup DSP thay th·∫ø DSP g·ªëc
}

enum VisitSource {
  MOBILE // DSP check in/out t·ª´ app ƒëi·ªán tho·∫°i
  OFFICE_EDIT // vƒÉn ph√≤ng nh·∫≠p / ch·ªânh tay
  AUTO_MATCH // h·ªá th·ªëng t·ª± g·∫Øn visit v·ªõi ca schedule
}

enum CancelledBy {
  INDIVIDUAL
  DSP
  OFFICE
}

// =====================================================
//  MASTER SCHEDULE TEMPLATE (l·ªãch c·ª©ng ‚Äì Master Week)
// =====================================================

model MasterScheduleTemplate {
  id            String    @id @default(cuid())
  individualId  String
  name          String? // VD: "Weekday template"
  effectiveFrom DateTime // ng√†y b·∫Øt ƒë·∫ßu √°p d·ª•ng
  effectiveTo   DateTime? // null = √°p d·ª•ng v√¥ th·ªùi h·∫°n
  isActive      Boolean   @default(true)
  notes         String?

  individual    Individual            @relation(fields: [individualId], references: [id], onDelete: Cascade)
  shifts        MasterTemplateShift[]
  scheduleWeeks ScheduleWeek[] // ƒë·∫ßu kia c·ªßa relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId, isActive])
}

model MasterTemplateShift {
  id         String @id @default(cuid())
  templateId String
  dayOfWeek  Int // 0 = Sun, 6 = Sat
  serviceId  String

  // Th·ªùi gian trong ng√†y, t√≠nh theo ph√∫t t·ª´ 00:00 (VD: 7h = 420)
  startMinutes Int
  endMinutes   Int

  // DSP m·∫∑c ƒë·ªãnh (c√≥ th·ªÉ null, th·ª±c t·∫ø assign ·ªü Weekly)
  defaultDspId String?
  billable     Boolean @default(true)
  notes        String?

  template   MasterScheduleTemplate @relation(fields: [templateId], references: [id])
  service    Service                @relation(fields: [serviceId], references: [id])
  defaultDsp Employee?              @relation("TemplateDefaultDSP", fields: [defaultDspId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId, dayOfWeek])
}

// =====================================================
//  WEEKLY SCHEDULE (PLAN) ‚Äì hi·ªÉn th·ªã ·ªü Weekly Detail
// =====================================================

model ScheduleWeek {
  id                    String   @id @default(cuid())
  individualId          String
  templateId            String? // generate t·ª´ template n√†o (n·∫øu c√≥)
  weekStart             DateTime // Ch·ªß nh·∫≠t 00:00
  weekEnd               DateTime // Th·ª© 7 23:59 ho·∫∑c weekStart + 7 ng√†y
  generatedFromTemplate Boolean  @default(true)
  notes                 String?
  locked                Boolean  @default(false) // ƒë√£ kh√≥a khi payroll/billing xong

  individual Individual              @relation(fields: [individualId], references: [id], onDelete: Cascade)
  template   MasterScheduleTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  shifts     ScheduleShift[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId, weekStart])
}

model ScheduleShift {
  id           String @id @default(cuid())
  weekId       String
  individualId String
  serviceId    String

  // DSP g·ªëc (plan) v√† DSP th·ª±c t·∫ø (backup ho·∫∑c tr√πng lu√¥n)
  plannedDspId String?
  actualDspId  String?

  scheduleDate DateTime // ng√†y c·ªßa ca (00:00)
  plannedStart DateTime // th·ªùi gian b·∫Øt ƒë·∫ßu plan
  plannedEnd   DateTime // th·ªùi gian k·∫øt th√∫c plan

  status ScheduleStatus @default(NOT_STARTED)

  cancelledBy  CancelledBy?
  cancelledAt  DateTime?
  cancelReason String?

  backupNote String? // "ABC replacing Garret due to ..."

  billable Boolean @default(true)
  notes    String?

  week       ScheduleWeek @relation(fields: [weekId], references: [id])
  individual Individual   @relation(fields: [individualId], references: [id], onDelete: Cascade)
  service    Service      @relation(fields: [serviceId], references: [id])

  plannedDsp Employee? @relation("PlannedDSP", fields: [plannedDspId], references: [id])
  actualDsp  Employee? @relation("ActualDSP", fields: [actualDspId], references: [id])

  visits Visit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([weekId])
  @@index([scheduleDate])
  @@index([individualId, scheduleDate])
  @@index([plannedDspId, scheduleDate])
  @@index([actualDspId, scheduleDate])
}

// =====================================================
//  VISIT (th·ª±c t·∫ø ‚Äì Check in/Out) ‚Äì cho Billing & Payroll
// =====================================================

model Visit {
  id String @id @default(cuid())

  scheduleShiftId String? // c√≥ th·ªÉ null n·∫øu l√† unscheduled / backup ch∆∞a g·∫Øn ca
  individualId    String
  dspId           String
  serviceId       String?

  checkInAt  DateTime
  checkOutAt DateTime?

  source VisitSource @default(MOBILE)

  // cache s·∫µn ƒë·ªÉ report nhanh (t√≠nh khi close visit)
  durationMinutes   Int? // t·ªïng s·ªë ph√∫t (Out - In, c√≥ x·ª≠ l√Ω qua ng√†y)
  units             Int? // s·ªë unit 15 ph√∫t
  isBillable        Boolean @default(true)
  nonBillableReason String?

  gpsLatitude  Float? // optional ‚Äì sau n√†y d√πng cho GPS
  gpsLongitude Float?

  scheduleShift ScheduleShift? @relation(fields: [scheduleShiftId], references: [id])
  individual    Individual     @relation(fields: [individualId], references: [id], onDelete: Cascade)
  dsp           Employee       @relation("VisitDSP", fields: [dspId], references: [id])
  service       Service?       @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduleShiftId])
  @@index([dspId, checkInAt])
  @@index([individualId, checkInAt])
}

// =====================================================
//  DAILY NOTE (m·ªõi ‚Äì ch·ªâ l∆∞u scalar ID + cache)
// =====================================================

model DailyNote {
  id String @id @default(cuid())

  // Li√™n k·∫øt
  shiftId      String
  visitId      String?
  individualId String
  staffId      String
  serviceId    String?

  // Ng√†y cung c·∫•p d·ªãch v·ª• (Daily Note)
  date DateTime

  // Th√¥ng tin cache ƒë·ªÉ show ·ªü Reports cho nhanh
  individualName String
  staffName      String?
  serviceCode    String
  serviceName    String
  scheduleStart  String
  scheduleEnd    String
  visitStart     String?
  visitEnd       String?

  // Mileage / cancel
  mileage      Float?
  isCanceled   Boolean @default(false)
  cancelReason String?

  // To√†n b·ªô payload Daily Note (bao g·ªìm notes, meals, signatures...)
  payload Json

  // Sau n√†y Phase DOC/PDF s·∫Ω d√πng 2 field n√†y
  staffReportFileId      String? // file tr√™n REPORTS-STAFT
  individualReportFileId String? // file tr√™n REPORTS-INDIVIDUAL

  // NEW: direct-download report paths (saved on server filesystem)
  staffReportDocPath      String?
  staffReportPdfPath      String?
  individualReportDocPath String?
  individualReportPdfPath String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([individualId, date])
  @@index([staffId, date])
}

// =====================================================
//  ISP ALLOCATION (H·ª£p ƒë·ªìng ISP ‚Äì units ƒë∆∞·ª£c c·∫•p)
// =====================================================

model ISPAllocation {
  id           String  @id @default(cuid())
  individualId String
  serviceId    String
  payerId      String? // Medicaid, ODP, etc.

  startDate DateTime // ng√†y b·∫Øt ƒë·∫ßu ·ªßy quy·ªÅn
  endDate   DateTime? // ng√†y k·∫øt th√∫c (h·∫øt h·ª£p ƒë·ªìng)

  unitsPerWeek         Int? // ISP quy ƒë·ªãnh m·ªói tu·∫ßn bao nhi√™u unit
  unitsPerMonth        Int? // ho·∫∑c m·ªói th√°ng
  totalAuthorizedUnits Int? // t·ªïng s·ªë unit cho c·∫£ h·ª£p ƒë·ªìng

  notes String?

  individual Individual @relation(fields: [individualId], references: [id], onDelete: Cascade)
  service    Service    @relation(fields: [serviceId], references: [id])
  payer      Payer?     @relation(fields: [payerId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId, serviceId, startDate])
}

// =====================================================
//  ISP & BSP FORM (l∆∞u to√†n b·ªô form d·∫°ng JSON)
// =====================================================

model IspBspForm {
  id           String @id @default(cuid())
  individualId String @unique
  formData     Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  individual Individual @relation(fields: [individualId], references: [id], onDelete: Cascade)
}

// =====================================================
//  ADMIN USERS / ROLES / PRIVILEGES
// =====================================================

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  firstName String
  lastName  String
  locked    Boolean @default(false)
  userType  String  @default("ADMIN") // ADMIN / COORDINATOR / DSP / ...

  roles       UserRole[]
  privileges  UserPrivilege[]
  supervisors UserSupervisor[]

  // ====== NEW: password fields ======
  passwordHash      String?
  passwordSalt      String?
  passwordUpdatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

model Role {
  id          String  @id @default(cuid())
  code        String  @unique // vd: "COORDINATOR"
  name        String // label hi·ªÉn th·ªã ƒë·∫πp
  description String?

  users UserRole[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_roles")
}

model Privilege {
  id          String  @id @default(cuid())
  code        String  @unique // vd: "CLIENT_ACCESS_MODULE"
  name        String // label hi·ªÉn th·ªã d√†i
  description String?

  users UserPrivilege[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_privileges")
}

model UserRole {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId String

  @@unique([userId, roleId])
  @@map("admin_user_roles")
}

model UserPrivilege {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  privilege   Privilege @relation(fields: [privilegeId], references: [id], onDelete: Cascade)
  privilegeId String

  @@unique([userId, privilegeId])
  @@map("admin_user_privileges")
}

model UserSupervisor {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  supervisor   Employee @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  supervisorId String

  @@unique([userId, supervisorId])
  @@map("admin_user_supervisors")
}

// =====================================================
//  MEDICATION MODULE (Orders, MAR, Inventory, Incidents)
// =====================================================

// Lo·∫°i order: thu·ªëc l·ªãch (Scheduled) hay PRN
enum MedicationType {
  SCHEDULED
  PRN
}

// Tr·∫°ng th√°i order
enum MedicationOrderStatus {
  ACTIVE
  ON_HOLD
  DISCONTINUED
}

// Tr·∫°ng th√°i t·ª´ng l·∫ßn u·ªëng/ti√™m trong MAR
enum MedicationAdminStatus {
  GIVEN
  REFUSED
  MISSED
  HELD
  LATE
  ERROR
}

// M·ª©c ƒë·ªô nghi√™m tr·ªçng c·ªßa incident
enum MedicationIncidentSeverity {
  LOW
  MODERATE
  HIGH
}

// Tr·∫°ng th√°i x·ª≠ l√Ω incident
enum MedicationIncidentStatus {
  OPEN
  IN_REVIEW
  CLOSED
}

/**
 * MedicationOrder = y l·ªánh thu·ªëc (ƒë∆°n thu·ªëc) cho t·ª´ng Individual
 */
model MedicationOrder {
  id             String                @id @default(cuid())
  individualId   String // link sang Individual qua id (string)
  medicationName String
  form           String? // tablet, capsule, solution...
  doseValue      Float
  doseUnit       String // mg, ml, tablet...
  route          String // PO, IM, IV, SQ...
  type           MedicationType
  frequencyText  String? // ‚ÄúBID‚Äù, ‚ÄúQHS‚Äù‚Ä¶
  timesOfDay     String[]              @default([])
  startDate      DateTime
  endDate        DateTime?
  status         MedicationOrderStatus @default(ACTIVE)

  prescriberName String?
  pharmacyName   String?
  indications    String? // l√Ω do d√πng thu·ªëc
  allergyFlag    Boolean @default(false)

  // Relations n·ªôi b·ªô Medication
  administrations MedicationAdministration[]
  inventoryItems  MedicationInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId, status])
}

/**
 * MedicationAdministration = m·ªói l·∫ßn c·∫•p thu·ªëc trong MAR
 */
model MedicationAdministration {
  id      String          @id @default(cuid())
  orderId String
  order   MedicationOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  individualId      String // l∆∞u th√™m ƒë·ªÉ query nhanh
  scheduledDateTime DateTime
  actualDateTime    DateTime?
  status            MedicationAdminStatus
  reason            String? // reason/refused/missed...
  vitalsSummary     String? // "BP 120/70, HR 76, BG 145"
  staffId           String? // id DSP
  staffName         String? // t√™n DSP, cache ƒë·ªÉ kh√¥ng ph·∫£i join

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId, scheduledDateTime])
  @@index([orderId, scheduledDateTime])
}

/**
 * MedicationInventory = t·ªìn kho thu·ªëc theo t·ª´ng Individual
 */
model MedicationInventory {
  id      String           @id @default(cuid())
  orderId String?
  order   MedicationOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  individualId    String
  medicationName  String // cache t√™n thu·ªëc ƒë·ªÉ xem nhanh
  isControlled    Boolean   @default(false)
  currentQuantity Float
  unit            String // tablet, ml...
  minThreshold    Float     @default(0)
  daysRemaining   Int?
  lastCountDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId])
  @@index([individualId, isControlled])
}

/**
 * MedicationIncident = l·ªói thu·ªëc, Missed dose, Medication error...
 */
model MedicationIncident {
  id             String                     @id @default(cuid())
  individualId   String
  individualName String
  date           DateTime
  medicationName String?
  type           String // "Missed Dose", "Medication Error", ...
  severity       MedicationIncidentSeverity
  status         MedicationIncidentStatus   @default(OPEN)
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([individualId, date])
  @@index([severity])
  @@index([status])
}

model MobileLoginOtp {
  id        String    @id @default(cuid())
  email     String
  code      String
  staffId   String
  staffName String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email])
  @@index([email, code])
}

//
// ‚úÖ NEW: Mobile Refresh Tokens (Remember device for 90 days)
// - Store hash only (tokenHash)
// - staffId links to Employee.id (DSP)
// - expiresAt enforces 90-day re-verify requirement
//
model MobileRefreshToken {
  id        String @id @default(cuid())
  staffId   String
  email     String
  tokenHash String

  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  staff Employee @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([tokenHash])
  @@index([staffId])
  @@index([email])
  @@index([expiresAt])
  @@index([revokedAt])
}
